<script>
  document.addEventListener('DOMContentLoaded', function () {
    let questions = [];

    async function fetchQuestions() {
      const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRGaQUicMab31gW8tHrnsf-qp5X8dTf599d8B3SfBHV-08KK-O5v3gn135DeD1cakS-PA8e5Nnp26Vq/pub?gid=0&single=true&output=csv'; // Pega tu URL de CSV aquí

      try {
        const res = await fetch(sheetUrl);
        const data = await res.text();
        const rows = data.split('\n').filter(row => row.trim() !== '');

        questions = rows.map((row, index) => ({
          id: index + 1,
          text: row.split(',')[0].replace(/"/g, '')
        }));

        renderQuestions();
      } catch (error) {
        alert('No se pudieron cargar las preguntas desde Sheets');
      }
    }

    function updateProgress() {
      const answered = document.querySelectorAll('input[type="radio"]:checked').length;
      const total = questions.length;
      const percent = total > 0 ? Math.round((answered / total) * 100) : 0;

      document.getElementById('progress-count').textContent = `${answered}/${total}`;
      document.getElementById('progress-percent').textContent = `${percent}%`;
      document.getElementById('progress-fill').style.width = `${percent}%`;
    }

    function renderQuestions() {
      const container = document.getElementById('questionsContainer');
      container.innerHTML = '';

      questions.forEach((q, index) => {
        container.innerHTML += `
          <div class="question-card" data-id="${q.id}">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div class="question-text">${index + 1}. ${q.text}</div>
              <button class="delete-btn" data-id="${q.id}">✕</button>
            </div>
            <div class="options-grid">
              <label class="option-label" for="yes-${q.id}">
                <input type="radio" name="q${q.id}" value="yes" id="yes-${q.id}">
                <div class="custom-radio"></div>
                <span class="option-text">Sí</span>
              </label>
              <label class="option-label" for="no-${q.id}">
                <input type="radio" name="q${q.id}" value="no" id="no-${q.id}">
                <div class="custom-radio"></div>
                <span class="option-text">No</span>
              </label>
              <label class="option-label" for="neutral-${q.id}">
                <input type="radio" name="q${q.id}" value="no_answer" id="neutral-${q.id}">
                <div class="custom-radio"></div>
                <span class="option-text">Prefiero no responder</span>
              </label>
            </div>
          </div>
        `;
      });

      updateProgress();

      document.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', updateProgress);
      });

      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', function () {
          const id = parseInt(this.getAttribute('data-id'));
          questions = questions.filter(q => q.id !== id);
          renderQuestions();
        });
      });
    }

    document.getElementById('addQuestion').addEventListener('click', function () {
      const newId = questions.length > 0 ? Math.max(...questions.map(q => q.id)) + 1 : 1;
      const text = prompt('Ingrese el texto de la nueva pregunta:');
      if (text) {
        questions.push({ id: newId, text: text });
        renderQuestions();
      }
    });

    document.getElementById('submitBtn').addEventListener('click', async function () {
      const answers = {};
      let allAnswered = true;

      questions.forEach(q => {
        const selected = document.querySelector(`input[name="q${q.id}"]:checked`);
        if (selected) {
          answers[`q${q.id}`] = selected.value;
        } else {
          allAnswered = false;
        }
      });

      if (allAnswered) {
        try {
          const webhookUrl = 'http://localhost:5678/webhook-test/entrada_encuesta'; // Reemplaza por tu URL de n8n si ya está online

          const response = await fetch(webhookUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              survey_data: answers,
              timestamp: new Date().toISOString()
            })
          });

          if (response.ok) {
            alert('¡Respuestas enviadas a n8n con éxito!');
          } else {
            alert('Error al enviar. Código: ' + response.status);
          }
        } catch (error) {
          alert('Error de conexión: ' + error.message);
        }
      } else {
        alert('Por favor responde todas las preguntas antes de enviar.');
      }
    });

    fetchQuestions();
  });
</script>
